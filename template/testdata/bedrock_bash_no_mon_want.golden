#!/bin/bash
iptables -I INPUT -j ACCEPT
tee /tmp/server.properties <<EOF
server-port=19132
level-seed=minectlrocks
view-distance=10
enable-jmx-monitoring=false

EOF
tee /etc/systemd/system/minecraft.service <<EOF
[Unit]
Description=Minecraft Server
Documentation=https://www.minecraft.net/en-us/download/server
DefaultDependencies=no
After=network.target

[Service]
WorkingDirectory=/minecraft
Type=simple
ExecStart=/bin/sh -c "LD_LIBRARY_PATH=. ./bedrock_server"
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF
apt update
apt-get install -y apt-transport-https ca-certificates curl unzip fail2ban

sed -i 's/#Port 22/Port 0/g' /etc/ssh/sshd_config
service sshd restart

tee /etc/fail2ban/jail.local <<EOF
[sshd]
port = 0
enabled = true
maxretry = 0
bantime = 0
ignoreip = 
EOF

systemctl restart fail2ban
mkdir -p /minecraft
URL=$(curl -s https://bedrock-version.minectl.ediri.online/binary/1.17.10.04)
curl -sLSf $URL > /tmp/bedrock-server.zip
unzip -o /tmp/bedrock-server.zip -d /minecraft
chmod +x /minecraft/bedrock_server
wget http://security.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.1-1ubuntu2.1~18.04.20_amd64.deb
dpkg -i libssl1.1_1.1.1-1ubuntu2.1~18.04.20_amd64.deb
echo "eula=false" > /minecraft/eula.txt
mv /tmp/server.properties /minecraft/server.properties
chmod a+rwx /minecraft
systemctl restart minecraft.service
systemctl enable minecraft.service