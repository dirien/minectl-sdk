#!/bin/bash
iptables -I INPUT -j ACCEPT
tee /tmp/server.properties <<EOF
server-port=25565
level-seed=minectlrocks
view-distance=10
enable-jmx-monitoring=false

broadcast-rcon-to-ops=true
rcon.port=2
enable-rcon=true
rcon.password=test
EOF
tee /etc/systemd/system/minecraft.service <<EOF
[Unit]
Description=Minecraft Server
Documentation=https://www.minecraft.net/en-us/download/server
DefaultDependencies=no
After=network.target

[Service]
WorkingDirectory=/minecraft
Type=simple
ExecStart=/usr/bin/java -Xmx2G -Xms2G -jar server.jar nogui
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF
apt update
apt-get install -y apt-transport-https ca-certificates curl openjdk-16-jre-headless fail2ban

sed -i 's/#Port 22/Port 0/g' /etc/ssh/sshd_config
service sshd restart

tee /etc/fail2ban/jail.local <<EOF
[sshd]
port = 0
enabled = true
maxretry = 0
bantime = 0
ignoreip = 
EOF

systemctl restart fail2ban
mkdir -p /minecraft
mkfs.ext4  /dev/sda
mount /dev/sda /minecraft
echo "/dev/sda /minecraft ext4 defaults,noatime,nofail 0 2" >> /etc/fstab
URL="https://maven.fabricmc.net/net/fabricmc/fabric-installer/1.0.1/fabric-installer-1.0.1.jar"
mkdir /tmp/build
cd /tmp/build
curl -sLSf $URL > fabric-installer.jar
java -jar fabric-installer.jar server -downloadMinecraft -mcversion 1.17.1-138
echo "serverJar=minecraft-server.jar" > /minecraft/fabric-server-launcher.properties
cp /tmp/build/fabric-server-launch.jar /minecraft/minecraft-server.jar
cp /tmp/build/server.jar /minecraft/server.jar
rm -rf /tmp/build
echo "eula=true" > /minecraft/eula.txt
mv /tmp/server.properties /minecraft/server.properties
chmod a+rwx /minecraft
systemctl restart minecraft.service
systemctl enable minecraft.service