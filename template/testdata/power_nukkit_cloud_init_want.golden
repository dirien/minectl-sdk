#cloud-config
users:
  - default
package_update: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - openjdk-8-jre-headless
  - fail2ban
fs_setup:
  - label: minecraft
    device: /dev/sda
    filesystem: xfs
    overwrite: false

mounts:
  - [/dev/sda, /minecraft]
# Enable ipv4 forwarding, required on CIS hardened machines
write_files:
  - path: /etc/sysctl.d/enabled_ipv4_forwarding.conf
    content: |
      net.ipv4.conf.all.forwarding=1
  - path: /tmp/server.properties
    content: |
       level-seed=minectlrocks
       view-distance=10
       enable-jmx-monitoring=false
       broadcast-rcon-to-ops=true
       rcon.port=2
       enable-rcon=true
       rcon.password=test
       server-port=19132
  - path: /etc/systemd/system/minecraft.service
    content: |
      [Unit]
      Description=Minecraft Server
      Documentation=https://www.minecraft.net/en-us/download/server
      DefaultDependencies=no
      After=network.target
      [Service]
      WorkingDirectory=/minecraft
      Type=simple
      ExecStart=/usr/bin/java -Xmx2G -Xms2G -jar server.jar nogui --language eng
      Restart=on-failure
      RestartSec=5
      [Install]
      WantedBy=multi-user.target
  - path: /etc/fail2ban/jail.local
    content: |
      [sshd]
      port = 0
      enabled = true
      maxretry = 0
      bantime = 0
      ignoreip = 

runcmd:
  - iptables -I INPUT -j ACCEPT
  - sed -i 's/#Port 22/Port 0/g' /etc/ssh/sshd_config
  - service sshd restart
  - systemctl restart fail2ban
  - URL="https://github.com/PowerNukkit/PowerNukkit/releases/download/v1.5.1.0-PN/powernukkit-1.5.1.0-PN-shaded.jar"
  - curl -sLSf $URL > /minecraft/server.jar
  - echo "eula=true" > /minecraft/eula.txt
  - mv /tmp/server.properties /minecraft/server.properties
  - chmod a+rwx /minecraft
  - systemctl restart minecraft.service
  - systemctl enable minecraft.service